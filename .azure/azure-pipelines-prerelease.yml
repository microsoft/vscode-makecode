name: vscode-makecode PreRelease

# Currently only run this pipeline on request 
trigger: none
pr: none

resources:
  repositories:
  - repository: CustomPipelineTemplates
    type: git
    name: 1ESPipelineTemplates/MicroBuildTemplate

variables:
- group: 'makecode-marketplace-pat'

extends:
  template: azure-pipelines/MicroBuild.1ES.Official.yml@CustomPipelineTemplates
  parameters:
    pool:
      vmImage: 'ubuntu-latest'

    stages:
      # Stage to build the VSIX and publish it
    - template: templates/build.yml
      parameters:
        isPreRelease: true

    - template: templates/sign.yml
      parameters:
        signType: 'test'

      # Stage provides a manual approval step before the publish stage is run
    - stage: Approval
      displayName: Approve the release
      jobs:
      - deployment: ApproveRelease
        displayName: "Approve Release"
        environment: "makecode" # Defined in AzDO Pipeline environments
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: none

      # Publish the VSIX to the extension marketplace 
    - stage: Publish
      displayName: Publish the VSIX
      dependsOn:
        - Build
        - Approval
        - Sign
      jobs:
      - job: Publish
        variables:
        - name: vsixName
          value: $[ stageDependencies.Build.Build.outputs['SetExtensionName.VSIX'] ]
        steps:
        - template: templates/publish.yml
          parameters:
            isPreRelease: true
